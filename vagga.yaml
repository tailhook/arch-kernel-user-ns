containers:
  arch:
    setup:
    - !Tar
      url: http://mirrors.nix.org.ua/linux/archlinux/iso/2015.12.01/archlinux-bootstrap-2015.12.01-x86_64.tar.gz
      subdir: root.x86_64
    - !CacheDirs { /var/cache/pacman: arch-packages }
    - !Text
      /etc/pacman.d/mirrorlist: |
        Server = http://mirrors.nix.org.ua/linux/archlinux/$repo/os/$arch
      # unfortunately Tar above overwrites resolv.conf, hopefull this is enough
      /etc/resolv.conf: |
        nameserver 8.8.8.8
        nameserver 8.8.4.4
    - !Sh |
        pacman-key --init
        pacman-key --populate archlinux
        pacman -Syu --noconfirm
    # build tools
    - !Sh "pacman -S --noconfirm base-devel git"
    # for kernel
    - !Sh "pacman -S --noconfirm xmlto docbook-xsl inetutils bc"
    - !EnsureDir /build  # hack, but useful
    - !EnsureDir /work/build  # hack, but useful
    auto-clean: true

commands:

  build-package: !Command
    container: arch
    user-id: 1
    external-user-id: 0
    work-dir: packages/linux/repos/core-x86_64
    accepts-arguments: true
    run: |
      [ -d /work/dist ] || mkdir /work/dist
      rm dist/*.tar.xz
      PKGDEST=/work/dist makepkg --skippgpcheck --log "$@"

  prepare-package: !Command
    container: arch
    user-id: 1
    external-user-id: 0
    work-dir: packages/linux/repos/core-x86_64
    run: [/work/patch_package.sh]

  make-repo: !Command
    container: arch
    user-id: 1
    external-user-id: 0
    run: |
      repo-add dist/repo.db.tar.xz dist/*
